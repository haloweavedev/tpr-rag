<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minerva | The Passionate Reader</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              beige: {
                50: '#FDFBF9',
                100: '#F9F5F0', // Main Background
                200: '#F2EBE0',
                300: '#E6DCCF',
                800: '#4A4641',
                900: '#2D2A26', // Primary Text
              },
              primary: {
                DEFAULT: '#FF1D8D', // Rose Pink
                light: '#FF64B0',
                dark: '#D6006D',
                10: '#FF1D8D1A',
                20: '#FF1D8D33',
              },
            },
            fontFamily: {
              serif: ['"Playfair Display"', 'serif'],
              sans: ['"Manrope"', 'sans-serif'],
            },
            boxShadow: {
              'book': '0 10px 30px -5px rgba(45, 42, 38, 0.15)',
              'soft': '0 4px 30px rgba(127, 133, 193, 0.1)',
            },
            animation: {
              'fade-in': 'fadeIn 0.6s ease-out forwards',
              'slide-up': 'slideUp 0.6s ease-out forwards',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #F9F5F0;
        color: #2D2A26;
        -webkit-font-smoothing: antialiased;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #E6DCCF;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #D4C5B0;
      }
      
      .typing-dot {
        animation: typing 1.4s infinite ease-in-out both;
      }
      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }
      
      @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
      }

      /* Markdown Styles inside bot messages */
      .prose p { margin-bottom: 0.75em; line-height: 1.7; }
      .prose strong { color: #D6006D; font-weight: 600; }
      .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.75em; }
      .prose li { margin-bottom: 0.25em; }
      .prose h3 { font-family: "Playfair Display", serif; font-size: 1.25em; margin-top: 1em; margin-bottom: 0.5em; color: #2D2A26; }
    </style>
  </head>
  <body class="h-screen flex flex-col overflow-hidden bg-beige-100 selection:bg-primary/20 selection:text-primary-dark">
    
    <!-- Header (Minimal) -->
    <header class="w-full py-6 px-8 flex justify-between items-center z-50 fixed top-0 left-0 bg-gradient-to-b from-beige-100 via-beige-100/90 to-transparent pointer-events-none">
        <div class="pointer-events-auto flex items-center gap-3">
             <div class="w-8 h-8 rounded-full bg-white shadow-soft flex items-center justify-center text-primary border border-primary/10">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z" />
                </svg>
            </div>
            <span class="font-serif text-lg font-medium text-beige-900 tracking-tight">Minerva</span>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 w-full max-w-4xl mx-auto flex flex-col h-full relative pt-24 pb-4">
      
      <!-- Content Container -->
      <div id="content-container" class="flex-1 overflow-y-auto px-[clamp(1.5rem,5vw,2rem)] scroll-smooth no-scrollbar flex flex-col pb-4">
        
        <!-- WELCOME STATE (Initially Visible) -->
        <div id="welcome-view" class="flex flex-col items-center justify-center h-full min-h-[50vh] transition-all duration-500 ease-in-out opacity-100 transform translate-y-0">
            
            <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-white shadow-[0_10px_40px_-10px_rgba(255,29,141,0.2)] flex items-center justify-center text-primary mb-8 animate-fade-in border border-primary/10">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z" />
                </svg>
            </div>

            <h1 class="font-serif text-4xl md:text-5xl text-beige-900 text-center mb-4 animate-slide-up" style="animation-delay: 0.1s;">
                Good afternoon, Reader.
            </h1>
            <p class="font-sans text-lg text-beige-800/60 text-center max-w-xl mb-12 animate-slide-up" style="animation-delay: 0.2s;">
                I am Minerva. How can I help you discover your next great love story today?
            </p>

            <!-- Suggested Topics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-2xl animate-slide-up" style="animation-delay: 0.3s;">
                <button onclick="startChat('Find me a cozy Christmas romance')" class="text-left p-6 rounded-2xl bg-white border border-beige-200 hover:border-primary/30 hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group">
                    <div class="w-8 h-8 rounded-full bg-beige-100 text-primary flex items-center justify-center mb-4 group-hover:bg-primary group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" />
                        </svg>
                    </div>
                    <span class="font-serif text-lg font-medium text-beige-900 block mb-1">Cozy Christmas</span>
                    <span class="font-sans text-xs text-beige-800/60 font-medium tracking-wide uppercase">Warm & Festive</span>
                </button>

                <button onclick="startChat('Historical romance with a strong heroine')" class="text-left p-6 rounded-2xl bg-white border border-beige-200 hover:border-primary/30 hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group">
                     <div class="w-8 h-8 rounded-full bg-beige-100 text-primary flex items-center justify-center mb-4 group-hover:bg-primary group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
                        </svg>
                    </div>
                    <span class="font-serif text-lg font-medium text-beige-900 block mb-1">Strong Heroines</span>
                    <span class="font-sans text-xs text-beige-800/60 font-medium tracking-wide uppercase">Historical Fiction</span>
                </button>

                <button onclick="startChat('Best enemies to lovers books')" class="text-left p-6 rounded-2xl bg-white border border-beige-200 hover:border-primary/30 hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group">
                     <div class="w-8 h-8 rounded-full bg-beige-100 text-primary flex items-center justify-center mb-4 group-hover:bg-primary group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.05 4.575a1.575 1.575 0 10-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 013.15 0v1.5m-3.15 0l.075 5.925m3.075.75V4.575m0 0a1.575 1.575 0 013.15 0v3m3.15-3v1.5a1.575 1.575 0 01-3.15 0v-1.5m-3.15 0l.075 5.925m3.075.75V4.575m0 0a1.575 1.575 0 013.15 0v3m3.15-3v1.5a1.575 1.575 0 01-3.15 0v-1.5M4.5 19.5h15a2.25 2.25 0 002.25-2.25V9a2.25 2.25 0 00-2.25-2.25h-15A2.25 2.25 0 002.25 9v8.25A2.25 2.25 0 004.5 19.5z" />
                        </svg>
                    </div>
                    <span class="font-serif text-lg font-medium text-beige-900 block mb-1">Enemies to Lovers</span>
                    <span class="font-sans text-xs text-beige-800/60 font-medium tracking-wide uppercase">High Stakes & Tension</span>
                </button>
                 <button onclick="startChat('Show me recent 5 star reviews')" class="text-left p-6 rounded-2xl bg-white border border-beige-200 hover:border-primary/30 hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group">
                     <div class="w-8 h-8 rounded-full bg-beige-100 text-primary flex items-center justify-center mb-4 group-hover:bg-primary group-hover:text-white transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
                        </svg>
                    </div>
                    <span class="font-serif text-lg font-medium text-beige-900 block mb-1">Top Rated</span>
                    <span class="font-sans text-xs text-beige-800/60 font-medium tracking-wide uppercase">Cream of the Crop</span>
                </button>
            </div>
        </div>

        <!-- CHAT MESSAGES (Initially Hidden) -->
        <div id="messages" class="flex-col gap-6 w-full hidden">
            <!-- Messages injected here -->
        </div>

      </div>

      <!-- Input Area -->
      <div class="w-full px-[clamp(1.5rem,5vw,2rem)] z-40 bg-beige-100 pb-2">
        <div class="max-w-3xl mx-auto relative">
          <form onsubmit="event.preventDefault(); handleUserSubmit();" class="relative group">
            <input 
              type="text" 
              id="user-input"
              placeholder="Ask Minerva..." 
              class="w-full bg-white border-2 border-beige-300 rounded-full py-4 pl-6 pr-14 text-beige-900 placeholder:text-beige-400 focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all font-sans text-base shadow-soft"
              autocomplete="off"
            >
            <button 
              type="submit" 
              class="absolute right-2 top-2 bottom-2 aspect-square rounded-full bg-primary text-white flex items-center justify-center shadow-md hover:bg-primary-dark hover:scale-105 transition-all duration-200"
              aria-label="Send message"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 ml-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
              </svg>
            </button>
          </form>
          <p class="text-center text-[10px] text-beige-800/40 mt-3 font-sans font-medium tracking-wide">Powered by Haloweave</p>
        </div>
      </div>

    </main>

    <!-- Script -->
    <script>
      const messagesDiv = document.getElementById('messages');
      const userInput = document.getElementById('user-input');
      const welcomeView = document.getElementById('welcome-view');
      const contentContainer = document.getElementById('content-container');
      let isChatStarted = false;
      
      // Generate Session ID
      const sessionId = crypto.randomUUID ? crypto.randomUUID() : 'session-' + Date.now() + '-' + Math.random().toString(36).substring(2);
      console.log("Session ID:", sessionId);

      function switchToChatMode() {
          if (!isChatStarted) {
              isChatStarted = true;
              welcomeView.style.opacity = '0';
              welcomeView.style.transform = 'translateY(-20px)';
              setTimeout(() => {
                  welcomeView.style.display = 'none';
                  messagesDiv.classList.remove('hidden');
                  messagesDiv.classList.add('flex');
              }, 400);
          }
      }

      function startChat(text) {
          switchToChatMode();
          userInput.value = text;
          handleUserSubmit();
      }

      function handleUserSubmit() {
          const text = userInput.value.trim();
          if (!text) return;
          switchToChatMode();
          sendMessage(text);
      }

      function scrollToBottom() {
        requestAnimationFrame(() => {
          contentContainer.scrollTop = contentContainer.scrollHeight;
        });
      }

      function createLoadingBubble() {
        const id = 'loading-' + Date.now();
        const html = `
          <div id="${id}" class="flex gap-4 max-w-3xl mx-auto w-full animate-fade-in pt-4">
             <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary mt-1 border border-primary/5">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z" />
                </svg>
              </div>
              <div class="flex flex-col gap-2">
                <span class="font-sans text-[10px] font-bold text-beige-900/40 uppercase tracking-widest">Minerva</span>
                <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-beige-200 inline-flex items-center gap-1 w-fit">
                  <div class="w-1.5 h-1.5 bg-primary/40 rounded-full typing-dot"></div>
                  <div class="w-1.5 h-1.5 bg-primary/40 rounded-full typing-dot"></div>
                  <div class="w-1.5 h-1.5 bg-primary/40 rounded-full typing-dot"></div>
                </div>
              </div>
          </div>
        `;
        messagesDiv.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
        return id;
      }

      function appendUserMessage(text) {
        const html = `
          <div class="flex gap-4 max-w-3xl mx-auto w-full justify-end animate-slide-up pt-4">
            <div class="bg-primary text-white p-4 px-6 rounded-2xl rounded-br-none shadow-md max-w-xl font-sans text-[0.95rem] leading-relaxed">
              ${text.replace(/\n/g, '<br>')}
            </div>
          </div>
        `;
        messagesDiv.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
      }

      function appendBotMessage(text, sources = []) {
        // Format text (markdown to HTML basic)
        // We sanitized text in server prompt, now we format it
        let formattedText = text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/### (.*?)\n/g, '<h3>$1</h3>')
          .replace(/- (.*?)\n/g, '<li>$1</li>')
          .replace(/\n/g, '<br>');

        // Generate Book Cards HTML if sources exist
        let sourcesHtml = '';
        if (sources && sources.length > 0) {
            // Deduplicate
            const unique = [];
            const titles = new Set();
            for(const s of sources) {
                if(!titles.has(s.title)) {
                    titles.add(s.title);
                    unique.push(s);
                }
            }

            sourcesHtml = `
              <div class="mt-8 pt-6 border-t border-beige-100 w-full">
                <h4 class="font-sans text-[10px] font-bold text-beige-800/40 uppercase tracking-widest mb-4">Referenced Works</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                  ${unique.map(book => `
                    <div class="bg-beige-50 border border-beige-200 rounded-lg overflow-hidden group hover:shadow-book transition-all duration-300 flex flex-col h-full">
                      ${book.cover ? `<div class="aspect-[2/3] overflow-hidden bg-beige-200 relative"><div class="absolute inset-0 bg-black/5 group-hover:bg-transparent transition-colors duration-300"></div><img src="${book.cover}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700 ease-out" alt="${book.title}" onerror="this.style.display='none'"></div>` : ''}
                      <div class="p-4 flex flex-col flex-1">
                        <h5 class="font-serif font-bold text-beige-900 leading-tight mb-1 text-sm line-clamp-2 group-hover:text-primary transition-colors">${book.title}</h5>
                        <p class="font-sans text-xs text-beige-800/60 mb-2">${book.author}</p>
                        ${book.genres ? `<div class="mt-auto pt-2"><span class="inline-block px-2 py-1 bg-beige-200/60 rounded text-[9px] text-beige-800 font-bold tracking-wide uppercase">${book.genres.split(',')[0]}</span></div>` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
        }

        const html = `
          <div class="flex gap-4 max-w-3xl mx-auto w-full animate-fade-in group pt-4">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary mt-1 group-hover:bg-primary group-hover:text-white transition-colors duration-300 border border-primary/5">
               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z" />
                </svg>
            </div>
            <div class="flex flex-col gap-2 w-full min-w-0">
              <span class="font-sans text-[10px] font-bold text-beige-900/40 uppercase tracking-widest">Minerva</span>
              <div class="bg-white p-6 md:p-8 rounded-2xl rounded-tl-none shadow-sm border border-beige-200 text-beige-900 font-serif leading-loose text-[1.05rem] prose max-w-none">
                ${formattedText}
                ${sourcesHtml}
              </div>
            </div>
          </div>
        `;
        messagesDiv.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
      }

      async function sendMessage(text) {
        // Clear input and show user message
        userInput.value = '';
        appendUserMessage(text);

        // Show loading
        const loadingId = createLoadingBubble();

        try {
          const response = await fetch('/api/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: text, sessionId: sessionId })
          });
          
          const data = await response.json();
          
          // Remove loading bubble
          document.getElementById(loadingId)?.remove();

          if (data.error) {
             appendBotMessage("I apologize, but I encountered an error connecting to my library.");
          } else {
             appendBotMessage(data.reply, data.sources);
          }

        } catch (err) {
          document.getElementById(loadingId)?.remove();
          appendBotMessage("I seem to be having trouble reaching the server at the moment.");
          console.error(err);
        }
      }
    </script>
  </body>
</html>